<%- include('header') %>

<div class="body-content">

    <% if (!isAdmin) { %>
    <!-- ============================
         AGENT VIEW (DEFAULT)
    ============================ -->

    <!-- CARD: المبلغ الذي يجب تأكيده -->
    <div class="card mb-4">
        <div class="card-body text-center">
            <h5 class="fw-bold">المبلغ الذي يجب تأكيده</h5>
            <p class="fs-3 fw-black text-danger"><%= needtobesetteled %> EGP</p>
        </div>
    </div>

    <!-- FILTERS + TITLE -->
    <div class="card-header">
        <h6 class="fs-17 fw-semi-bold mb-3">Reservations List</h6>

        <div class="row g-2">
            <div class="col-md-2">
                <input type="text" id="filterTripID" class="form-control" placeholder="Trip ID">
            </div>

            <div class="col-md-2">
                <input type="date" id="filterDate" class="form-control">
            </div>

            <div class="col-md-2">
                <input type="text" id="filterRoute" class="form-control" placeholder="Route">
            </div>

            <div class="col-md-2">
                <button type="button" class="btn btn-secondary w-100" id="resetFilters">Reset</button>
            </div>
        </div>
    </div>

    <!-- TABLE -->
    <div class="card mb-4">
        <div class="card-body">

            <div class="table-responsive" style="overflow-x:auto; max-height:70vh;">
                <table class="table table-bordered table-striped table-hover" id="agentlist">

                    <thead>
                        <tr>
                            <th>Trip ID</th>
                            <th>Trip Date</th>
                            <th>Trip Time</th>
                            <th>Reserved Count</th>
                            <th>Reserved Seats</th>
                            <th>Available Seats</th>
                            <th>Bus</th>
                            <th>Route</th>
                            <th>Action</th>
                        </tr>
                    </thead>

                    <tbody>
                        <% for (let i = 0; i < reservations.length; i++) { %>
                            <tr>
                                <td><%= reservations[i].trip_id %></td>
                                <td><%= reservations[i].trip_date %></td>
                                <td><%= reservations[i].trip_time.join(" - ") %></td>
                                <td><%= reservations[i].reservedSeats_counter %></td>
                                <td><%= reservations[i].reservedSeats %></td>
                                <td><%= reservations[i].available_seats %></td>
                                <td><%= reservations[i].bus %></td>
                                <td><%= reservations[i].route_names.join(" - ") %></td>

                                <td>
                                    <a href="/reservation/print/pdf/<%= reservations[i].id %>"
                                       class="btn btn-dark btn-sm">
                                        <i class="fas fa-file-pdf"></i>
                                    </a>
                                </td>
                            </tr>
                        <% } %>
                    </tbody>

                </table>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const filterTripIDInput = document.getElementById("filterTripID");
        const filterDateInput = document.getElementById("filterDate");
        const filterRouteInput = document.getElementById("filterRoute");
        const resetBtn = document.getElementById("resetFilters");
        const table = document.getElementById("agentlist");

        if (!filterTripIDInput || !filterDateInput || !filterRouteInput || !table) return;

        const rows = table.getElementsByTagName("tr");

        const today = new Date().toISOString().split("T")[0];
        filterDateInput.value = today;

        function normalizeRowDate(rawDate) {
            let d = rawDate.trim();

            if (d.includes("T")) {
                return d.split("T")[0];
            }

            if (d.includes(" ")) {
                return d.split(" ")[0];
            }

            return d;
        }

        function filterTable() {
            const tripID = filterTripIDInput.value.toLowerCase();
            const date = filterDateInput.value;
            const route = filterRouteInput.value.toLowerCase();

            for (let i = 1; i < rows.length; i++) { 
                const cells = rows[i].getElementsByTagName("td");
                if (!cells.length) continue;

                const id = cells[0].textContent.toLowerCase();
                const rawDate = cells[1].textContent;
                const rowDate = normalizeRowDate(rawDate);
                const routeName = cells[7].textContent.toLowerCase();

                let match = true;

                if (tripID && !id.includes(tripID)) match = false;
                if (date && rowDate !== date) match = false;
                if (route && !routeName.includes(route)) match = false;

                rows[i].style.display = match ? "" : "none";
            }
        }

        filterTripIDInput.addEventListener("input", filterTable);
        filterDateInput.addEventListener("change", filterTable);
        filterRouteInput.addEventListener("input", filterTable);

        resetBtn.addEventListener("click", function () {
            filterTripIDInput.value = "";
            filterRouteInput.value = "";
            filterDateInput.value = today; 
            filterTable();
        });

        filterTable();
    });
    </script>

    <% } else { %>

    <!-- ======================================
         ADMIN VIEW — AGENTS CARDS
    ======================================= -->

    <div class="card-header mb-4">
        <h4 class="fw-bold">All Agents – Financial Overview</h4>
    </div>

    <div class="row">
        <% AgentsMapped.forEach(agent => { %>

            <div class="col-md-4 mb-4">
                <div class="card shadow-sm">
                    <div class="card-body">

                        <h5 class="fw-bold"><%= agent.name %></h5>
                        <p class="mb-1"><strong>Phone:</strong> <%= agent.phone %></p>
                        <p class="mb-1"><strong>Total Sales:</strong> <%= agent.totalsales %> EGP</p>
                        <p class="mb-1"><strong>Needed Commissions:</strong> <%= agent.neededcommetions %> EGP</p>
                        <p class="mb-1"><strong>Settled:</strong> <%= agent.setteled %> EGP</p>

                        <hr>

                        <h5 class="text-danger fw-bold">
                            Remaining: <%= agent.needtobesetteled %> EGP
                        </h5>

                        <a href="/employee/money/<%= agent.id %>"
                           class="btn btn-primary btn-sm w-100 mt-2">
                            View Details
                        </a>

                    </div>
                </div>
            </div>

        <% }) %>
    </div>

    <% } %>

</div>

<!-- FOOTER JS -->
<script src="js/metisMenu/metisMenu.min.js"></script>
<script src="js/perfect-scrollbar/dist/perfect-scrollbar.min.js"></script>
<script src="js/sidebar.js"></script>
<script src="js/common.js"></script>

</html>
